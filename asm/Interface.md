# 8255A

https://wenku.baidu.com/view/1f7ce2d0b14e852458fb57b6.html

## 数据端口: A, B, C

## 控制端口: D

8位端口, 无对外引脚可用来和外设传送信息

![image-20191215205811603](D:\Note\asm\Interface.assets\image-20191215205811603.png)



![image-20191215205924232](D:\Note\asm\Interface.assets\image-20191215205924232.png)

![image-20191215210003019](D:\Note\asm\Interface.assets\image-20191215210003019.png)

字母上面的横杠表示低电平有效, 如$RD$ 有横杠, 所以是读操作

## 三种工作方式

### 方式 0

- 单向传送端口, 输入或输出
- 每一个口都可以作为基本的输入输出口, C口高位, C口低位, A口, B口都可以单独设置为输入输出口

### 方式 1

- 单向传送端口, C口作为A口, B口联络信号的引脚
- 数据端口: A口, B口

### 方式 2

双向传送, 即可输入又可输出

只有A口可以工作在方式2下

![image-20191215212051944](D:\Note\asm\Interface.assets\image-20191215212051944.png)

# 8253

https://wenku.baidu.com/view/d87ef5c12cc58bd63186bd19.html

https://blog.csdn.net/u013007900/article/details/50408903

- 4个端口, 3个定时器各占1个, 控制端口占1个

## 寄存器

初值寄存器CR

状态寄存器SR

输出锁存器OL

状态锁存器SL

## 引脚

- 8位数据线: 与CPU相连

- WR, RD, CS, A0, A1的用途与8255一样

- 外部引脚

  - D7～D0：双向数据线，与系统数据总线相连，供CPU 对8253 进行读/写操作，进行信息交换

  - A1～A0：地址输入信号，用于选择8253 内部寄存器

    ![image-20191216162834579](D:\Note\asm\Interface.assets\image-20191216162834579.png)

  - CLK: 输入脉冲信号

    外部脉冲信号输入端CLK0、CLK1、CLK2，分别为计数器0、计数器1、计数器2的脉冲信号输入端。**计数器对该引脚输入的脉冲信号进行计数**，CLK 脉冲信号可以由系统时钟、系统时钟分频或者其他脉冲源提供。CLK 输入脉冲可以是均匀的、连续的或周期精确的信号，也可以是不均匀的、不连续的或非周期的信号

    如果输入脉冲是精确的时钟信号，则8253起定时作用

    如果输入脉冲是非周期的信号，则8253起计数作用

  - OUT: 输出信号

    **定时时间到**或**计数减为零**的向外输出信号端OUT0、OUT1、OUT2，分别为计数器0、计数器1、计数器2 的脉冲信号输出端。无论8253 的计数器工作在什么方式，当计数器减到0 时，信号输出端OUT 必定有一个电平或脉冲信号输出，用以指示定时时间到或者计数结束。该信号可供CPU 检测，也可以作为中断请求信号

  - GATE: 输入门控信号

    是一根外部控制计数器工作的输入信号线，**用作控制<u>启动</u>或<u>中止</u>定时/计数**。对于8253 这6 种不同的工作方式，GATE 信号的有效方式也不同，可以是上升沿信号有效或是电平信号有效。

## 内部逻辑

![image-20191216154420408](D:\Note\asm\Interface.assets\image-20191216154420408.png)

![image-20191216154433662](D:\Note\asm\Interface.assets\image-20191216154433662.png)

## 编程

- 控制寄存器格式

  ![image-20191216154703525](D:\Note\asm\Interface.assets\image-20191216154703525.png)

## 计数过程中读计数值

### 锁存

> 把信号暂存以维持某种电平状态

### 锁存器

> 输出端的状态不会随输入端状态变化而变化
>
> 
>
> 只有在有锁存信号时, 输入的状态被保存到输出, 然后直到下一个锁存信号到来时才改变

### 读取当前计数值

1. 先向控制寄存器写锁存命令 (即D5D4 = 00), 把当前计数值所存到锁存器
2. 执行读相应端口的数据

### 读取装入的计数值

1. 直接读取相应的端口
2. 分两次读出: 先低字节, 后高字节

## 工作方式

### 方式0

> 计数结束产生中断

- 向计数器写完计数值时, 开始计数, OUT变为0

- 计数到0时, OUT输出为1

- GATE为高电平时(上升沿), 计数器工作, 为低电平时停止计数

- 在计数时, 若重新写入新的计数值, 则按新的值重新工作

  ![image-20191216162229824](D:\Note\asm\Interface.assets\image-20191216162229824.png)

### 方式3

输出方波

# 8254

> 有3个独立的16位通用定时计数器

与8253的引脚和功能完全相同, 只是最高工作频率比8253高, 有读回命令(可以读取当前值)

# 8259

https://blog.csdn.net/longintchar/article/details/79439466

> PIC (Programmable Interrupt Controller)
>
> 可编程中断控制器
>
> 微机系统中管理设备中断请求的管理者

- INTR中断

## 工作原理

在总线控制器控制下，8259A芯片可以处于**编程状态**和**操作状态**。

- 编程状态是CPU使用IN或OUT指令对8259A芯片进行初始化编程的状态。

- 一旦完成了初始化编程，芯片即进入操作状态，此时芯片即可随时响应外部设备提出的中断请求（IRQ0 -IRQ15），同时<u>系统还可以使用操作命令字随时修改其中断处理方式</u>。

通过**中断判优选择**，芯片将选中当前最高优先级的中断请求作为中断服务对象，并通过CPU引脚INT通知CPU中断请求的到来，CPU响应后，芯片从数据总线D7-D0将编程设定的当前服务对象的中断号送出，CPU由此获取对应的中断向量值，并执行中断服务程序。



逻辑框图如下：

![image-20191216201030329](D:\Note\asm\Interface.assets\image-20191216201030329.png)

### 中断请求寄存器 

> IRR (Interrupt Request Register) 

- 用来保存中断请求输入引脚上所有请求

- 寄存器的8个比特位（D7—D0）分别对应引脚IR7—IR0

### 中断屏蔽寄存器 

> IMR (Interrup Mask Register)

- 用于保存被屏蔽的中断请求线对应的比特位
- 哪个比特位被置1就屏蔽哪一级中断请求
- IMR对IRR进行处理，其每个比特位对应IRR的每个请求比特位。对高优先级输入线的屏蔽并不会影响低优先级中断请求线的输入。

### 优先级解析器

> PR (Priority Resolver)

- 用于确定 IRR 中所设置比特位的优先级，选通最高优先级的中断请求到 正在服务寄存器**ISR (In-Service Register)**中

### 正在服务寄存器

> ISR (In-Service Register)

- ISR中保存着正在接受服务的中断请求

---

- 来自各个设备的中断请求线分别连接到8259A的IR0—IR7引脚上

- 当这些引脚上有一个或多个中断**请求信号到来时**，中断请求寄存器 IRR 中相应的**比特位被 置位 锁存**

- 此时若中断屏蔽寄存器 **IMR 中对应位被置位** (置位,赋值为1; 复位, 赋值为0)，则相应的**中断请求就不会送到优先级解析器 PR** 中。

- 未屏蔽的中断请求被送到优先级解析器之后，优先级最高的中断请求会被选出。
- 此时8259A就会向CPU发送一个**INT**信号 (中断信号)
- 而CPU则会在执行完当前的一条指令之后向8259A发送一个**INTA**（INTERRUPT ACKNOWLEDGE）来响应中断信号
- 8259A在收到这个响应信号之后就会把所选出的**最高优先级中断请求保存到正在服务寄存器ISR中**，即ISR中对应比特被置位
- 与此同时，中断请求寄存器 IRR 中的对应比特位被复位，表示该中断请求开始被处理
- 此后，CPU会向8259A发出第2个INTA脉冲信号，该信号用于通知 8259A送出中断号
- 在该脉冲信号期间，8259A就会把一个代表中断号的8位数据发送到数据总线上供CPU读取。
- 到此为止，CPU中断周期结束
  - 如果8259A使用的是自动结束中断(**AEOI**，Automatic End of Interrupt) 方式，那么在第2个 INTA 脉冲信号的结尾处正在服务寄存器 ISR 中的当前服务中断比特位就会被复位。
  - 若8259A 使用非自动结束方式，那么在中断服务程序结束时，程序就需要向8259A发送一个结束中断（**EOI**）命令以复位 ISR 中的比特位。
  - 如果中断请求来自级联的第2个8259A芯片，那么就需要向两个芯片都发送EOI命令。此后8259A就会去判断下一个最高优先级的中断，并重复上述处理过程。

## 工作流程

1. 当中断请求输入线IR0~IR7中有一条或多条变高时, 则中断请求寄存器IRR的相应位置 置"1"
2. 若中断请求线中至少有一条是中断允许的, 则**PIC**向**处理器** 1(CPU) 的INT引脚发出一个**中断信号**
3. **处理器**立刻停下当时所做的事情并询问PIC需要执行哪个中断服务请求
4. **PIC**通过向**数据总线**发出与中断请求对应的**中断号**来告知处理器要执行哪个中断服务过程
5. **处理器**根据读取的中断号查询**中断向量表**（在32位保护模式下是中断描述符表）取得相关设备的**中断向量**（即中断服务程序的地址）并开始执行中断服务程序
6. 中断服务程序执行结束，处理器继续执行被中断信号打断的程序

### 级联

- 每个8259A可以管理8个中断源, 通过级联最多管理64个

  ![image-20191216191525479](D:\Note\asm\Interface.assets\image-20191216191525479.png)



## 中断优先级

### 固定优先级

- 优先级由高到低的顺序是：IR0, IR1, IR2, …, IR7。其中，IR0的优先级最高，IR7的优先级最低

### 自动循环优先级

- 在自动循环优先权方式中，IR7～IR0的优先级别是可以改变的，而且是自动改变。

- 其变化规律是：当某一个中断请求`IRi`服务结束后，该中断的优先级自动降为最低，而紧跟其后的中断请求`IR(i＋1)`的优先级自动升为最高。

#### 普通自动循环

IR0～IR7中的初始最低优先级由系统指定，即指定IR7的优先级最低

#### 特殊自动循环

IR0～IR7中的初始最低优先级由用户指定（通过OCW2）



## 中断嵌套方式

### 普通嵌套方式

在CPU中断服务期间，若有新的中断请求到来，只允许比当前服务的优先级更**高**的中断请求进入，对于“同级”或“低级”的中断请求则禁止响应。

### 特殊完全嵌套方式

- 除了允许高级别中断请求进入外，还允许同级中断请求进入，从而实现了对同级中断请求的特殊嵌套。



- 在多片8259A级联的情况下，主片通常设置为特殊完全嵌套方式，从片设置为普通嵌套方式。当主片响应某一个从片的中断请求时，从片中的 IR7～IR0 的请求都是通过主片中的某个`IRi`请求引入的。因此从片的 IR7～IR0 对于主片`IRi`来说，它们属于同级，只有主片工作于特殊完全嵌套方式时，从片才能实现完全嵌套。

## 中断屏蔽方式

### 普通屏蔽方式

写入操作命令字 OCW1，将中断屏蔽寄存器(IMR)中的`Di`位置1，以达到对`IRi`（`i＝0～7`）中断请求的屏蔽

![image-20191216205056992](D:\Note\asm\Interface.assets\image-20191216205056992.png)

- 若 `Mi`=1，则屏蔽对应中断请求级`IRi`

- 若 `Mi`=0，则允许`IRi`
- 另外，屏蔽高优先级并不会影响其他低优先级的中断请求

### 特殊屏蔽方式



## 中断结束方式

### 普通结束方式

通过在中断服务子程序中编程写入操作命令字OCW2，向8259A传送一个普通中断结束（EOI，end of interrupt）命令（命令中不指定要复位的中断级）来清除ISR中优先级别最高的置位

### 自动结束方式

### 特殊结束方式

特殊结束方式是通过在中断服务子程序中编程写入操作命令字OCW2，向8259A传送一个特殊EOI命令（命令中指定出要复位的中断级）来清除ISR中的指定位



## 中断触发方式

8259A中断请求输入端 IR7～IR0 的触发方式有电平触发和边沿触发两种，由初始化命令字ICW1中的LTIM位来设定

### 电平触发方式

- 当 LTIM=1 时，为电平触发方式
- 当8259A检测到 `IRi`（`i＝0～7`）端有高电平时产生中断。在这种触发方式中，要求触发电平必须保持到中断响应信号INTA有效为止
- 在CPU响应中断后，应及时撤销该请求信号，以防止CPU再次响应，出现重复中断现象

### 边沿触发方式

当 LTIM=0 时，为边沿触发方式。当8259A检测到`IRi`端有由低到高的跳变（上升沿）信号时产生中断



## 编程

### 初始化命令字

> Initialization Command Words

- **在8259A可以正常工作之前，必须首先设置初始化命令字 ICW 寄存器组的内容**

#### ICW1

> 初始化字

- A0=0, D4=1
- 必须写到偶地址端口

![image-20191217192553738](D:\Note\asm\Interface.assets\image-20191217192553738.png)

#### ICW2

> 中断向量字

- 必须写在奇地址端口
- A0=1

#### ICW3

> 级联控制字

- 必须写在奇地址端口

### 操作命令字

> Operation Command Words

- **在工作过程中，则可以使用写入操作命令字 OCW 寄存器组来随时设置和管理8259A的工作方式**

#### OCW1

> 中断屏蔽字

- 用于对 8259A 中中断屏蔽寄存器 IMR 进行读/写操作

- 地址线**A0**需为1, 奇地址

  ![image-20191216212545181](D:\Note\asm\Interface.assets\image-20191216212545181.png)

- 若 `Mi`=1，则屏蔽对应中断请求级`IRi`

- 若 `Mi`=0，则允许`IRi`

#### OW2

> 中断结束和优先级循环控制字

- A0=0, 写入偶地址                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
- 作用
  - 对8259A发出中断结束命令 (普通结束EOI和特殊结束SEOI)
  - 控制中断优先级的循环

- 命令字

| 位   | 名称  | 含义                                                         |
| ---- | ----- | ------------------------------------------------------------ |
| 7    | R     | 中断优先级是否按循环方式设置。R＝1表示采用循环方式，R＝0表示采用非循环方式。 |
| 6    | SL    | OCW2中的L2~L0是否有效。SL＝1表示有效，SL＝0表示无效。        |
| 5    | EOI   | 中断结束命令位。EOI＝1使当前ISR寄存器的相应位清0。当ICW4中的AEOI为0时，ISR中的相应置位就要由该命令位来清除。 |
| 4-3  | –     | 必须为00，00是OCW2的标识位。                                 |
| 2-0  | L2-L0 | 在SL=1时配合R、SL、EOI的设置，用来确定一个中断优先级的编码。L2、L1、L0 的8种编码000～111分别与IR0～IR7相对应。 |



| R    | SL   | EOI  | 优先级管理方式                      | 中断结束方式                 |
| ---- | ---- | ---- | ----------------------------------- | ---------------------------- |
| 0    | 0    | 1    | 固定优先级                          | 一般EOI                      |
| 0    | 1    | 1    | 固定优先级                          | 特殊EOI ，`ISR(L2~L0)`复位。 |
| 1    | 0    | 1    | 自动循环                            | 一般EOI                      |
| 1    | 0    | 0    | 设置自动循环方式（在AEOI模式下）    | —                            |
| 0    | 0    | 0    | 清除自动循环方式（在AEOI模式下）    | —                            |
| 1    | 1    | 0    | 设置优先级命令                      | —                            |
| 1    | 1    | 1    | 特殊循环，置`IR(L2~L0)`优先级为最低 | 特殊EOI ，`ISR(L2~L0)`复位。 |
| 0    | 1    | 0    | —                                   | —                            |

#### OW3

> 屏蔽和读状态控制字

- 用于设置或清除**特殊屏蔽方式**和**读取寄存器状态**（IRR 和 ISR）和**中断查询方式**
- 当 D4D3 = 01，且地址线 A0=0 时，表示对OCW3进行编程

| 位    | 名称    | 含义                                                         |
| ----- | ------- | ------------------------------------------------------------ |
| D7    | —       | 恒为0                                                        |
| D6    | ESMM    | SMM使能位。 ESMM=0，SMM的值不起用；ESMM=1，由SMM位决定是否工作在特殊屏蔽方式。 |
| D5    | SMM     | ESMM=1，SMM=0时，复位特殊屏蔽（表示8259A不是工作在特殊屏蔽方式）；ESMM=SMM=1，设置特殊屏蔽。 |
| D4-D3 | —       | **恒为01**，是OCW3的特征位                                   |
| D2    | P       | 查询命令(Poll Command)标识位。P=1，查询；P=0，不查询。       |
| D1-D0 | RR，RIS | RR（read register command）=1，表示读ISR或IRR。RR＝1，RIS＝0时，读取IRR；RR＝1，RIS＝1时，读取ISR。 |

### 端口地址

ICW必须顺序输入, ICW1,ICW2, (ICW3, ICW4)

![image-20191217194734894](D:\Note\asm\Interface.assets\image-20191217194734894.png)

